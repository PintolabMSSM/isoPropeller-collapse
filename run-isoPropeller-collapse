#!/bin/bash

########################################
# DEFINE GLOBAL ENVIRONMENT PARAMETERS #
########################################

CONDA_PKGS_DIRS="${PWD}/.snakemake/conda/pkgs"
GIT_REPODIR="${GIT_REPODIR:-$HOME/opt/isoPropeller-collapse}"
JOB_NCPUS="${JOB_NCPUS:=24}"

# Validate Snakefile location
if [[ ! -f "${GIT_REPODIR}/workflow/Snakefile" ]]; then
   echo "❌ Error: Snakefile not found in ${GIT_REPODIR}/workflow/"
   exit 2
fi

mkdir -p "${CONDA_PKGS_DIRS}"

export GIT_REPODIR
export CONDA_PKGS_DIRS

########################################
# DEFINE DEFAULT SNAKEMAKE PARAMETERS  #
########################################

DEFAULT_SNAKEMAKE_OPTS=(
  --profile   "${GIT_REPODIR}/workflow/profiles/minerva-lsf"
)

EXTRA_SNAKEMAKE_OPTS=()

##################################
# DEFINE REUSABLE HELP FUNCTION  #
##################################

show_help() {
  cat << EOF

Usage: run-isoPropeller-collapse -i <samples-csv> [options] [Snakemake args]

Required:
  -i <samples.csv>        CSV file with header (path_to_flnc,sample)

Optional:
  -C <config.yaml>        Use custom config file
  -D                      Dry run with printed shell commands (-p -n)
  -T                      Touch outputs only
  -help                   Show this help message

Extra Snakemake arguments (passed through):
  Any other flags will be forwarded directly to Snakemake and
  override defaults like --profile or --executor if provided.

EOF
}

############################
# PROCESS COMMANDLINE ARGS #
############################

if [[ $# -eq 0 ]]; then
  show_help
  exit 1
fi

while [[ $# -gt 0 ]]; do
  case "$1" in
    -i)
      SAMPLES="samples=$2"
      shift 2
      ;;
    -C)
      CONFIGFILE="--configfile $2"
      shift 2
      ;;
    -D)
      DEBUG="-p -n"
      shift
      ;;
    -T)
      TOUCH="--touch"
      shift
      ;;
    -help|--help)
      show_help
      exit 0
      ;;
    *)
      EXTRA_SNAKEMAKE_OPTS+=("$1")
      shift
      ;;
  esac
done

####################
# INPUT VALIDATION #
####################

if [[ -z "$SAMPLES" ]]; then
  echo -e "\n❌ Error: Missing required -i <samples.csv> argument.\n"
  show_help
  exit 1
fi

samples_file=$(echo "$SAMPLES" | cut -d= -f2)
if [[ ! -f "$samples_file" ]]; then
  echo -e "\n❌ Error: Input samples file not found: $samples_file\n"
  exit 1
fi

############################
# PREPARE THE JOB LOG FILE #
############################

timestamp="$(date +"%F_%H-%M-%S")${LSB_JOBID:+_lsf$LSB_JOBID}"
logfile="pipeline_${timestamp}.log"
echo "## Starting isoPropeller-collapse analysis: ${SAMPLES}" > "$logfile"
mkdir -p clusterlogs

#################################
# PREPARE SNAKEMAKE ENVIRONMENT #
#################################

module purge
unset PYTHONPATH PERL5LIB R_LIBS
module load anaconda3 singularity/3.6.4 proxies
source activate snakemake
export PATH="$GIT_REPODIR/bin:$PATH"

##################################
# BUILD FINAL SNAKEMAKE OPTIONS  #
##################################

SNAKEMAKE_OPTS=()
for opt in "${DEFAULT_SNAKEMAKE_OPTS[@]}"; do
  key=$(echo "$opt" | cut -d= -f1)
  skip=
  for useropt in "${EXTRA_SNAKEMAKE_OPTS[@]}"; do
    if [[ "$useropt" == "$key"* ]]; then
      skip=1
      break
    fi
  done
  [[ -z "$skip" ]] && SNAKEMAKE_OPTS+=("$opt")
done
SNAKEMAKE_OPTS+=("${EXTRA_SNAKEMAKE_OPTS[@]}")

############################
# START SNAKEMAKE PIPELINE #
############################

cmd="snakemake ${DEBUG} ${CONFIGFILE} ${TOUCH} \
  --snakefile ${GIT_REPODIR}/workflow/Snakefile \
  --config ${SAMPLES} \
  ${SNAKEMAKE_OPTS[@]}"

echo -e "\n## Run command\n$cmd\n\n## Pipeline output" >> "$logfile"

eval "$cmd" >> "$logfile" 2>&1

if [[ $? -eq 0 ]]; then
  echo -e "\n## PIPELINE COMPLETED SUCCESSFULLY" >> "$logfile"
  echo -e "\n## Generating DAG of executed steps..." >> "$logfile"

  snakemake \
    "${SNAKEMAKE_OPTS[@]}" \
    --snakefile "${GIT_REPODIR}/workflow/Snakefile" \
    ${CONFIGFILE} \
    --config ${SAMPLES} \
    --dag | dot -Tpdf > "pipeline_${timestamp}_dag.pdf" 2>> "$logfile"

  if [[ $? -eq 0 ]]; then
    echo "DAG saved to pipeline_${timestamp}_dag.pdf" >> "$logfile"
  else
    echo "Failed to generate DAG" >> "$logfile"
  fi
else
  echo -e "\n## PIPELINE FAILED WITH ERRORS" >> "$logfile"
fi
